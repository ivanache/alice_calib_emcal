#include <cstdio>
#include <cstdlib>

void to_sm_ieta_iphi_eta_phi(unsigned int &sm, unsigned int &ieta,
							 unsigned int &iphi, double &eta,
							 double &phi, unsigned int n)
{
	sm = n < 11520 ? n / 1152 :
		n < 12288 ? 10 + (n - 11520) / 384 :
		n < 16896 ? 12 + (n - 12288) / 768 :
		18 + (n - 16896) / 384;

	const unsigned int n0 =
		sm < 10 ? sm * 1152 :
		sm < 12 ? 11520 + (sm - 10) * 384 :
		sm < 18 ? 12288 + (sm - 12) * 768 :
		16896 + (sm - 18) * 384;
	const unsigned int n1 = n - n0;
	const unsigned int nphi =
		sm < 10 ? 24 : sm < 12 ? 8 : sm < 18 ? 24 : 8;

	ieta = 2 * (n1 / (2 * nphi)) + 1 - (n1 % 2);
	iphi = (n1 / 2) % nphi;

	const double coeff_eta[20][6] = {
		{ 0.6538761263736301, 0.0012502455282809458,
		  -0.00005435850122961024, -0.013757648176291852,
		  -0.000025569020644999157, 1.1116965497826313e-6 },
		{ -0.007266662087911644, -0.000048501557965879184,
		  2.108763389820745e-6, -0.013757648176291801,
		  -0.000025569020645007092, 1.1116965497829259e-6 },
		{ 0.6538761263736301, 0.0012502455282809458,
		  -0.00005435850122961024, -0.013757648176291852,
		  -0.000025569020644999157, 1.1116965497826313e-6 },
		{ -0.007266662087911644, -0.000048501557965879184,
		  2.108763389820745e-6, -0.013757648176291801,
		  -0.000025569020645007092, 1.1116965497829259e-6 },
		{ 0.6538761263736301, 0.0012502455282809458,
		  -0.00005435850122961024, -0.013757648176291852,
		  -0.000025569020644999157, 1.1116965497826313e-6 },
		{ -0.007266662087911644, -0.000048501557965879184,
		  2.108763389820745e-6, -0.013757648176291801,
		  -0.000025569020645007092, 1.1116965497829259e-6 },
		{ 0.6538761263736301, 0.0012502455282809458,
		  -0.00005435850122961024, -0.013757648176291852,
		  -0.000025569020644999157, 1.1116965497826313e-6 },
		{ -0.007266662087911644, -0.000048501557965879184,
		  2.108763389820745e-6, -0.013757648176291801,
		  -0.000025569020645007092, 1.1116965497829259e-6 },
		{ 0.6538761263736301, 0.0012502455282809458,
		  -0.00005435850122961024, -0.013757648176291852,
		  -0.000025569020644999157, 1.1116965497826313e-6 },
		{ -0.007266662087911644, -0.000048501557965879184,
		  2.108763389820745e-6, -0.013757648176291801,
		  -0.000025569020645007092, 1.1116965497829259e-6 },
		{ 0.6538955994897965, 0.0012327876984126996,
		  -0.00005219165046974383, -0.013757946609494863,
		  -0.000025332446808511946, 1.086380600873213e-6 },
		{ -0.0072721088435373045, -0.00004216269841272758,
		  1.131762228686001e-6, -0.01375794660949486,
		  -0.00002533244680851135, 1.0863806008729037e-6 },
		{ 0.6537747727272758, 0.0012291942148758277,
		  -0.00005344322673373451, -0.01375054364989851,
		  -0.00002391323211245261, 1.0397057440196336e-6 },
		{ -0.22750791958042052, -0.0004878840193896497,
		  0.000021212348669116138, -0.01375054364989848,
		  -0.00002391323211246439, 1.0397057440201827e-6 },
		{ 0.6537747727272758, 0.0012291942148758277,
		  -0.00005344322673373451, -0.01375054364989851,
		  -0.00002391323211245261, 1.0397057440196336e-6 },
		{ -0.22750791958042052, -0.0004878840193896497,
		  0.000021212348669116138, -0.01375054364989848,
		  -0.00002391323211246439, 1.0397057440201827e-6 },
		{ 0.6537747727272758, 0.0012291942148758277,
		  -0.00005344322673373451, -0.01375054364989851,
		  -0.00002391323211245261, 1.0397057440196336e-6 },
		{ -0.22750791958042052, -0.0004878840193896497,
		  0.000021212348669116138, -0.01375054364989848,
		  -0.00002391323211246439, 1.0397057440201827e-6 },
		{ 0.6538955994897965, 0.0012327876984126996,
		  -0.00005219165046974383, -0.013757946609494863,
		  -0.000025332446808511946, 1.086380600873213e-6 },
		{ -0.0072721088435373045, -0.00004216269841272758,
		  1.131762228686001e-6, -0.01375794660949486,
		  -0.00002533244680851135, 1.0863806008729037e-6 }
	};

	const double coeff_phi[20][4] = {
		{ 1.4153378750000025, 0.0006568888888901503,
		  0.013518083333333313, -0.000057045289855166094 },
		{ 1.4159947638888941, -0.0006568888888867641,
		  0.013461038043478247, 0.00005704528985495655 },
		{ 1.7644118472222259, 0.000646180555557041,
		  0.01351747826086953, -0.00005638586956534543 },
		{ 1.7650580277777765, -0.0006461805555546355,
		  0.013461092391304308, 0.00005638586956517725 },
		{ 2.1134724027777834, 0.0006524861111138665,
		  0.013517768115941999, -0.00005654166666683834 },
		{ 2.1141248888888984, -0.0006524861111081304,
		  0.013461226449275318, 0.000056541666666427527 },
		{ 2.462534333333343, 0.0006581805555594584,
		  0.013518074275362234, -0.00005697644927563384 },
		{ 2.463192513888897, -0.0006581805555524085,
		  0.013461097826086869, 0.000056976449275180296 },
		{ 2.8116099861111175, 0.0006471666666698442,
		  0.013517443840579645, -0.00005650181159440986 },
		{ 2.8122571527777906, -0.0006471666666621282,
		  0.013460942028985465, 0.00005650181159390807 },
		{ -3.12222569444445, 0.0006597222222129356,
		  0.013424007936509517, -0.00005902777777630214 },
		{ -3.121565972222227, -0.0006597222222309393,
		  0.013364980158731608, 0.000059027777779336 },
		{ -1.7262874166666704, 0.0008678541666655771,
		  0.013520961956521787, -0.00007551086956511075 },
		{ -1.7254195625000033, -0.000867854166667594,
		  0.013445451086956564, 0.00007551086956536232 },
		{ -1.3772168333333357, 0.000859541666666056,
		  0.013520576086956563, -0.00007492391304337749 },
		{ -1.3763572916666709, -0.000859541666667937,
		  0.013445652173913077, 0.00007492391304362568 },
		{ -1.0281504166666693, 0.0008688541666657723,
		  0.013520394021739162, -0.00007519021739121045 },
		{ -1.0272815625000018, -0.000868854166667404,
		  0.013445203804347865, 0.00007519021739139448 },
		{ -0.6787590277777789, 0.0006451388888869277,
		  0.013420585317460642, -0.00005367063492026231 },
		{ -0.67811388888889, -0.0006451388888908697,
		  0.01336691468254001, 0.000053670634921005446 }
	};

	eta = coeff_eta[sm][0] + coeff_eta[sm][1] * iphi +
		coeff_eta[sm][2] * iphi * iphi +
		coeff_eta[sm][3] * ieta + coeff_eta[sm][4] * ieta * iphi +
		coeff_eta[sm][5] * ieta * iphi * iphi;
	phi = coeff_phi[sm][0] + coeff_phi[sm][1] * (ieta % 2) +
		coeff_phi[sm][2] * iphi +
		coeff_phi[sm][3] * iphi * (ieta % 2);
}

int main(void)
{
	FILE *fp = fopen("mapping.txt", "r");
	unsigned int flat_index;
	unsigned int index_supermodule;
	unsigned int index_azimuth;
	unsigned int index_pseudorapidity;
	double pseudorapidity;
	double azimuth;

	while (fscanf(fp, "%u%u%u%u%lf%lf", &flat_index,
				  &index_supermodule, &index_azimuth,
				  &index_pseudorapidity, &pseudorapidity,
				  &azimuth) == 6) {
		unsigned int sm;
		unsigned int ieta;
		unsigned int iphi;
		double eta;
		double phi;

		to_sm_ieta_iphi_eta_phi(sm, ieta, iphi, eta, phi,
								flat_index);
		fprintf(stderr, "%u %u %u %u %u %u %u %lf %lf %lf %lf\n",
				flat_index, index_supermodule, sm,
				index_azimuth, iphi,
				index_pseudorapidity, ieta,
				pseudorapidity, eta, azimuth, phi);
		if (!(index_azimuth == iphi && index_azimuth == iphi &&
			  index_pseudorapidity == ieta)) {
			exit(1);
		}
	}

	fclose(fp);

	return 0;
}
